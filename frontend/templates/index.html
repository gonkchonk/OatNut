<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Smash Clone</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div id="game-container">
        <div id="login-section" class="section">
            <h2>Login to Play</h2>
            <form id="login-form">
                <input type="text" id="username" placeholder="Username" required>
                <input type="password" id="password" placeholder="Password" required>
                <button type="submit">Login</button>
            </form>
            <p>New player? <a href="#" id="show-register">Register here</a></p>
            <div id="login-status" style="margin-top: 10px; color: #ff6666;"></div>
        </div>

        <div id="game-section" class="section hidden">
            <canvas id="game-canvas"></canvas>
            <div id="player-info">
                <span id="player-name"></span>
                <span id="player-score">Score: 0</span>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        // Socket connection is optional on login page
        // We'll only establish it once user logs in
        let socket;
        
        // Check if user is already logged in
        const token = localStorage.getItem('gameAuthToken');
        const username = localStorage.getItem('username');
        
        if (token && username) {
            // User is already logged in, redirect to lobby
            window.location.href = '/lobby';
        }
        
        // For debugging purposes
        function initSocket() {
            socket = io({
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000
            });
            
            console.log('Socket initialized on login page');
            
            socket.on('connect', () => {
                console.log('Socket connected on login page:', socket.id);
            });
            
            socket.on('connect_error', (error) => {
                console.error('Socket connection error on login page:', error);
            });
            
            return socket;
        }
        
        // Check authentication status
        async function checkAuthStatus() {
            try {
                const token = localStorage.getItem('gameAuthToken');
                const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
                
                const response = await fetch('/api/auth/check', {
                    method: 'GET',
                    headers: headers
                });
                
                if (!response.ok) {
                    console.error('Auth check failed:', response.status);
                    return { success: false, authenticated: false };
                }
                
                const data = await response.json();
                console.log('Auth status:', data);
                
                if (data.authenticated) {
                    // If authenticated, redirect to lobby
                    window.location.href = '/lobby';
                }
                
                return data;
            } catch (error) {
                console.error('Auth check error:', error);
                return { success: false, authenticated: false };
            }
        }
        
        // Expose debug functions
        window.debugLogin = {
            initSocket: initSocket,
            checkAuthStatus: checkAuthStatus,
            checkLocalStorage: () => {
                console.log({
                    token: localStorage.getItem('gameAuthToken'),
                    username: localStorage.getItem('username')
                });
            },
            clearStorage: () => {
                localStorage.removeItem('gameAuthToken');
                localStorage.removeItem('username');
                console.log('Local storage cleared');
            }
        };
    </script>
    <script src="{{ url_for('static', filename='js/game.js') }}"></script>
</body>
</html> 