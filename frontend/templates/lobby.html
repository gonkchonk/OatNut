<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Lobby - Super Smash Clone</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div id="lobby-container">
        <header>
            <h1>Game Lobby</h1>
            <div id="user-info">
                <span>Welcome, <span id="lobby-username"></span>!</span>
                <button id="logout-btn">Logout</button>
            </div>
        </header>

        <main>
            <div class="create-room-section">
                <h2>Create a New Room</h2>
                <form id="create-room-form">
                    <input type="text" id="room-name" placeholder="Room Name" required>
                    <select id="max-players">
                        <option value="2">2 Players</option>
                        <option value="4" selected>4 Players</option>
                        <option value="8">8 Players</option>
                    </select>
                    <button type="submit">Create Room</button>
                </form>
            </div>

            <div class="active-users-section">
                <h2>Online Players</h2>
                <div id="active-users-list">
                    <p class="loading">Loading online players...</p>
                </div>
            </div>

            <div class="rooms-section">
                <h2>Available Rooms</h2>
                <div id="rooms-list">
                    {% if rooms %}
                        {% for room in rooms %}
                        <div class="room-card" data-room-id="{{ room._id }}">
                            <h3>{{ room.name }}</h3>
                            <p>Players: {{ room.players|length }}/{{ room.max_players }}</p>
                            <button class="join-btn" onclick="joinRoom('{{ room._id }}')">Join Room</button>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="no-rooms">No rooms available. Create one to get started!</p>
                    {% endif %}
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        // Get username from localStorage
        const username = localStorage.getItem('username');
        document.getElementById('lobby-username').textContent = username;

        // Check authentication status when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            const token = localStorage.getItem('gameAuthToken');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                const response = await fetch('/api/auth/check', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                if (!data.authenticated) {
                    // Clear invalid token
                    localStorage.removeItem('gameAuthToken');
                    localStorage.removeItem('username');
                    window.location.href = '/login';
                    return;
                }
                
                // Update UI with username
                document.getElementById('lobby-username').textContent = data.username;
                
                // Initialize socket connection only after successful auth
                initializeSocket(data.username);
            } catch (error) {
                console.error('Auth check failed:', error);
                localStorage.removeItem('gameAuthToken');
                localStorage.removeItem('username');
                window.location.href = '/login';
            }
        });

        // Move socket initialization to a separate function
        function initializeSocket(username) {
            // Initialize Socket.IO with reconnection options
            const socket = io({
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000
            });
            
            // Monitor socket connection status
            window.socketStatus = {
                connected: false,
                lastEvent: null,
                events: []
            };
            
            socket.on('connect', () => {
                console.log('Socket connected!', socket.id);
                window.socketStatus.connected = true;
                window.socketStatus.lastEvent = 'connect';
                window.socketStatus.events.push({event: 'connect', time: new Date()});
                
                // Notify server about user login
                socket.emit('user_login', { username });
            });
            
            socket.on('disconnect', () => {
                console.log('Socket disconnected!');
                window.socketStatus.connected = false;
                window.socketStatus.lastEvent = 'disconnect';
                window.socketStatus.events.push({event: 'disconnect', time: new Date()});
            });
            
            socket.on('connect_error', (error) => {
                console.error('Connection error:', error);
                window.socketStatus.lastEvent = 'connect_error';
                window.socketStatus.events.push({event: 'connect_error', time: new Date(), error});
            });
            
            // Expose a debug function
            window.checkSocketStatus = () => {
                console.log('Socket connected:', window.socketStatus.connected);
                console.log('Socket ID:', socket.id);
                console.log('Last event:', window.socketStatus.lastEvent);
                console.log('Recent events:', window.socketStatus.events.slice(-5));
                return window.socketStatus;
            };

            // Function to update active users list
            function updateActiveUsersList(users) {
                const activeUsersList = document.getElementById('active-users-list');
                if (!users || users.length === 0) {
                    activeUsersList.innerHTML = '<p class="no-users">No players online.</p>';
                    return;
                }

                let html = '<ul class="users-list">';
                users.forEach(user => {
                    const isCurrentUser = user === username;
                    html += `<li class="${isCurrentUser ? 'current-user' : ''}">${user} ${isCurrentUser ? '(You)' : ''}</li>`;
                });
                html += '</ul>';
                activeUsersList.innerHTML = html;
            }

            // Listen for active users updates
            socket.on('active_users_update', (users) => {
                updateActiveUsersList(users);
            });

            // Initialize active users list on page load
            fetch('/api/active-users')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to fetch active users: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    updateActiveUsersList(data.users);
                })
                .catch(error => {
                    console.error('Error fetching active users:', error);
                    // Show empty user list if there's an error
                    updateActiveUsersList([]);
                });

            // Function to update room list
            function updateRoomsList(rooms) {
                const roomsList = document.getElementById('rooms-list');
                if (!rooms || rooms.length === 0) {
                    roomsList.innerHTML = '<p class="no-rooms">No rooms available. Create one to get started!</p>';
                    return;
                }

                let html = '';
                rooms.forEach(room => {
                    html += `
                    <div class="room-card" data-room-id="${room._id}">
                        <h3>${room.name}</h3>
                        <p>Players: ${room.players.length}/${room.max_players}</p>
                        <button class="join-btn" onclick="joinRoom('${room._id}')">Join Room</button>
                    </div>`;
                });
                roomsList.innerHTML = html;
            }

            // Listen for room updates
            socket.on('room_update', () => {
                // Fetch updated room list
                fetch('/api/rooms')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            updateRoomsList(data.rooms);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching rooms:', error);
                    });
            });

            // Fetch rooms initially to ensure we have the latest data
            fetch('/api/rooms')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to fetch rooms: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        updateRoomsList(data.rooms);
                    } else {
                        throw new Error(data.message || 'Failed to fetch rooms');
                    }
                })
                .catch(error => {
                    console.error('Error fetching rooms:', error);
                    // Show empty rooms list if there's an error
                    updateRoomsList([]);
                });
        }

        // Logout functionality
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                // Notify server about user logout
                socket.emit('user_logout', { username });
                
                // Get token from local storage
                const token = localStorage.getItem('gameAuthToken');
                
                // Send logout request with token
                const logoutResponse = await fetch('/logout', {
                    method: 'GET',
                    headers: token ? {
                        'Authorization': `Bearer ${token}`
                    } : {}
                });
                
                // Clear local storage regardless of response
                localStorage.removeItem('gameAuthToken');
                localStorage.removeItem('username');
                
                console.log('Logged out successfully');
                window.location.href = '/';
            } catch (error) {
                console.error('Logout error:', error);
                
                // Clear storage even if there's an error
                localStorage.removeItem('gameAuthToken');
                localStorage.removeItem('username');
                
                // Redirect to home
                window.location.href = '/';
            }
        });

        // Create room functionality
        document.getElementById('create-room-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const roomName = document.getElementById('room-name').value;
            const maxPlayers = document.getElementById('max-players').value;

            try {
                const response = await fetch('/create-room', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: roomName, max_players: parseInt(maxPlayers) })
                });

                const data = await response.json();
                if (response.ok) {
                    // Redirect to the new room
                    window.location.href = `/join-room/${data.room_id}`;
                } else {
                    alert(data.message || 'Failed to create room.');
                }
            } catch (error) {
                console.error('Create room error:', error);
                alert('Failed to create room.');
            }
        });

        // Join room functionality
        function joinRoom(roomId) {
            console.log(`Joining room: ${roomId}`);
            
            // Show loading state
            const button = document.querySelector(`.room-card[data-room-id="${roomId}"] .join-btn`);
            if (button) {
                button.textContent = "Joining...";
                button.disabled = true;
            }
            
            try {
                window.location.href = `/join-room/${roomId}`;
            } catch (error) {
                console.error('Error joining room:', error);
                alert('Error joining room. Please try again.');
                
                // Reset button state
                if (button) {
                    button.textContent = "Join Room";
                    button.disabled = false;
                }
            }
        }
    </script>
</body>
</html> 