<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Lobby - Super Smash Clone</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div id="lobby-container">
        <header>
            <h1>Game Lobby</h1>
            <div id="user-info">
                <span>Welcome, <span id="lobby-username"></span>!</span>
                <button id="logout-btn">Logout</button>
            </div>
        </header>

        <main>
            <div class="create-room-section">
                <h2>Create a New Room</h2>
                <form id="create-room-form">
                    <input type="text" id="room-name" placeholder="Room Name" required>
                    <select id="max-players">
                        <option value="2">2 Players</option>
                        <option value="4" selected>4 Players</option>
                        <option value="8">8 Players</option>
                    </select>
                    <button type="submit">Create Room</button>
                </form>
            </div>

            <div class="active-users-section">
                <h2>Online Players</h2>
                <div id="active-users-list">
                    <p class="loading">Loading online players...</p>
                </div>
            </div>

            <div class="rooms-section">
                <h2>Available Rooms</h2>
                <div id="rooms-list">
                    {% if rooms %}
                        {% for room in rooms %}
                        <div class="room-card" data-room-id="{{ room._id }}">
                            <h3>{{ room.name }}</h3>
                            <p>Players: {{ room.players|length }}/{{ room.max_players }}</p>
                            <button class="join-btn" onclick="joinRoom('{{ room._id }}')">Join Room</button>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="no-rooms">No rooms available. Create one to get started!</p>
                    {% endif %}
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        // Get username from localStorage
        const username = localStorage.getItem('username');
        document.getElementById('lobby-username').textContent = username;

        // Initialize Socket.IO
        const socket = io();
        
        // Notify server about user login
        socket.on('connect', () => {
            socket.emit('user_login', { username });
        });

        // Function to update active users list
        function updateActiveUsersList(users) {
            const activeUsersList = document.getElementById('active-users-list');
            if (!users || users.length === 0) {
                activeUsersList.innerHTML = '<p class="no-users">No players online.</p>';
                return;
            }

            let html = '<ul class="users-list">';
            users.forEach(user => {
                const isCurrentUser = user === username;
                html += `<li class="${isCurrentUser ? 'current-user' : ''}">${user} ${isCurrentUser ? '(You)' : ''}</li>`;
            });
            html += '</ul>';
            activeUsersList.innerHTML = html;
        }

        // Listen for active users updates
        socket.on('active_users_update', (users) => {
            updateActiveUsersList(users);
        });

        // Initialize active users list on page load
        fetch('/api/active-users')
            .then(response => response.json())
            .then(data => {
                updateActiveUsersList(data.users);
            })
            .catch(error => {
                console.error('Error fetching active users:', error);
            });

        // Logout functionality
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                // Notify server about user logout
                socket.emit('user_logout', { username });
                
                await fetch('/logout');
                localStorage.removeItem('gameAuthToken');
                localStorage.removeItem('username');
                window.location.href = '/';
            } catch (error) {
                console.error('Logout error:', error);
            }
        });

        // Create room functionality
        document.getElementById('create-room-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const roomName = document.getElementById('room-name').value;
            const maxPlayers = document.getElementById('max-players').value;

            try {
                const response = await fetch('/create-room', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: roomName, max_players: parseInt(maxPlayers) })
                });

                const data = await response.json();
                if (response.ok) {
                    // Redirect to the new room
                    window.location.href = `/join-room/${data.room_id}`;
                } else {
                    alert(data.message || 'Failed to create room.');
                }
            } catch (error) {
                console.error('Create room error:', error);
                alert('Failed to create room.');
            }
        });

        // Join room functionality
        function joinRoom(roomId) {
            window.location.href = `/join-room/${roomId}`;
        }

        // Listen for room updates
        socket.on('room_update', (data) => {
            // Refresh the page to show updated room list
            window.location.reload();
        });
    </script>
</body>
</html> 