<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Room - Super Smash Clone</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div id="game-container">
        <header class="game-header">
            <h2 class="room-name">{{ room.name }}</h2>
            <div class="room-info">
                <span>Players: {{ room.players|length }}/{{ room.max_players }}</span>
                <button id="leave-room-btn">Leave Room</button>
            </div>
        </header>

        <div id="game-section">
            <canvas id="game-canvas"></canvas>
            <div id="player-info">
                <span id="player-name"></span>
                <span id="player-score">Score: 0</span>
            </div>
        </div>

        <div id="game-controls">
            <div class="controls-info">
                <h3>Controls</h3>
                <p>Use arrow keys to move</p>
                <p>Space to jump</p>
                <p>Z to attack</p>
            </div>
            <div class="player-list">
                <h3>Players</h3>
                <ul id="players">
                    {% for player in room.players %}
                    <li>{{ player }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        // Store room ID and current user
        const roomId = '{{ room_id }}';
        const currentUsername = localStorage.getItem('username');
        document.getElementById('player-name').textContent = currentUsername;

        // Initialize Socket.IO
        const socket = io();

        // Game canvas setup
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');

        // Resize canvas
        function resizeCanvas() {
            canvas.width = document.getElementById('game-section').clientWidth;
            canvas.height = document.getElementById('game-section').clientHeight;
            updateGame();
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Game state
        let gameState = {
            players: {},
            currentPlayer: currentUsername
        };

        // Join the room
        socket.emit('join_room', { 
            room_id: roomId, 
            username: currentUsername 
        });

        // Leave room button
        document.getElementById('leave-room-btn').addEventListener('click', () => {
            socket.emit('leave_room', { 
                room_id: roomId, 
                username: currentUsername 
            });
            window.location.href = '/lobby';
        });

        // Socket event handlers
        socket.on('player_joined', (data) => {
            console.log(`${data.username} joined the game`);
            gameState.players[data.username] = data.position;
            updatePlayersList(data.players);
            updateGame();
        });

        socket.on('player_left', (data) => {
            console.log(`${data.username} left the game`);
            delete gameState.players[data.username];
            updatePlayersList(data.players);
            updateGame();
        });

        socket.on('game_state', (state) => {
            gameState.players = state.players;
            updateGame();
        });

        function updatePlayersList(players) {
            const playersList = document.getElementById('players');
            playersList.innerHTML = '';
            
            players.forEach(player => {
                const li = document.createElement('li');
                li.textContent = player;
                if (player === currentUsername) {
                    li.classList.add('current-player');
                }
                playersList.appendChild(li);
            });
        }

        // Game loop
        function updateGame() {
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw platform
            ctx.fillStyle = '#333';
            ctx.fillRect(0, canvas.height - 50, canvas.width, 50);
            
            // Draw all players
            Object.entries(gameState.players).forEach(([username, position]) => {
                drawPlayer(position.x, position.y, username === gameState.currentPlayer);
            });
        }

        function drawPlayer(x, y, isCurrentPlayer) {
            ctx.fillStyle = isCurrentPlayer ? '#4CAF50' : '#ff4444';
            ctx.fillRect(x, y, 50, 50);
        }

        // Keyboard controls
        const keys = {};
        window.addEventListener('keydown', (e) => {
            keys[e.code] = true;
            handleInput();
        });

        window.addEventListener('keyup', (e) => {
            keys[e.code] = false;
        });

        function handleInput() {
            // If player doesn't exist in game state yet, initialize
            if (!gameState.players[currentUsername]) {
                gameState.players[currentUsername] = {
                    x: Math.random() * (canvas.width - 100) + 50,
                    y: 0
                };
            }

            const player = gameState.players[currentUsername];
            let moved = false;

            if (keys['ArrowLeft']) {
                player.x -= 5;
                moved = true;
            }
            if (keys['ArrowRight']) {
                player.x += 5;
                moved = true;
            }
            if (keys['Space'] && player.y === canvas.height - 100) {
                // Simple jump logic
                player.y -= 100;
                moved = true;
            }

            // Update position
            if (moved) {
                socket.emit('player_move', {
                    room_id: roomId,
                    username: currentUsername,
                    position: player
                });
                updateGame();
            }
        }

        // Gravity simulation
        function applyGravity() {
            if (gameState.players[currentUsername]) {
                const player = gameState.players[currentUsername];
                if (player.y < canvas.height - 100) { // Not on platform
                    player.y += 5;
                    socket.emit('player_move', {
                        room_id: roomId,
                        username: currentUsername,
                        position: player
                    });
                    updateGame();
                }
            }
        }

        // Start gravity loop
        setInterval(applyGravity, 100);
    </script>
</body>
</html> 