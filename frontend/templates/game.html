<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Room - Super Smash Clone</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #1a1a1a;
            color: white;
            font-family: Arial, sans-serif;
        }
        
        #game-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        #game-canvas {
            background-color: #333;
            border: 2px solid #4CAF50;
            margin-bottom: 20px;
            display: block;
        }
        
        #game-controls {
            display: flex;
            justify-content: space-between;
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
        }
        
        #players {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        #players li {
            padding: 8px;
            margin: 4px 0;
            background-color: #444;
            border-radius: 4px;
        }
        
        #players li.current-player {
            background-color: #4CAF50;
        }
        
        #leave-room-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        #score-display {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div class="game-header">
            <h2>{{ room.name }}</h2>
            <div>
                <span>Players: <span id="player-count">0</span>/4</span>
                <button id="leave-room-btn">Leave Room</button>
            </div>
        </div>

        <div id="game-section" style="position: relative;">
            <canvas id="game-canvas" width="800" height="600"></canvas>
            <div id="score-display">Score: <span id="player-score">0</span></div>
        </div>

        <div id="game-controls">
            <div class="controls-info">
                <h3>Controls</h3>
                <p>Use arrow keys to move</p>
                <p>Space to jump</p>
                <p>Z to attack</p>
            </div>
            <div class="player-list">
                <h3>Players</h3>
                <ul id="players"></ul>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const roomId = '{{ room._id }}';
        const currentUsername = localStorage.getItem('username');
        const socket = io();
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        
        // Set fixed canvas size
        canvas.width = 800;
        canvas.height = 600;

        // Initialize game state with current player
        let gameState = {
            players: {
                [currentUsername]: {
                    x: 400,
                    y: 500,
                    score: 0
                }
            }
        };

        // Debug logging
        console.log('Game initialized for user:', currentUsername);

        // Socket connection handling
        socket.on('connect', () => {
            console.log('Connected to WebSocket server');
            socket.emit('join_room', {
                room_id: roomId,
                username: currentUsername
            });
        });

        // Handle initial state when joining
        socket.on('initial_state', (data) => {
            console.log('Received initial state:', data);
            gameState.players = data.all_players;
            
            // Update player count
            document.getElementById('player-count').textContent = 
                `${data.player_count}/${data.max_players}`;
            
            // Update player list
            updatePlayersList(Object.keys(data.all_players));
            
            // Update game display
            updateGame();
        });

        // Handle game state updates
        socket.on('game_state', (state) => {
            console.log('Received game state update:', state);
            gameState.players = state.players;
            
            // Update player count
            document.getElementById('player-count').textContent = 
                `${state.player_count}/${state.max_players}`;
            
            // Update player list
            updatePlayersList(Object.keys(state.players));
            
            // Update game display
            updateGame();
        });

        function updatePlayersList(players) {
            console.log('Updating players list:', players);
            const playersList = document.getElementById('players');
            playersList.innerHTML = players.map(player => 
                `<li class="${player === currentUsername ? 'current-player' : ''}">${player}${player === currentUsername ? ' (You)' : ''}</li>`
            ).join('');
        }

        function updateGame() {
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw platform
            ctx.fillStyle = '#666';
            ctx.fillRect(0, canvas.height - 50, canvas.width, 50);

            // Draw all players
            Object.entries(gameState.players).forEach(([username, player]) => {
                // Draw player circle
                ctx.fillStyle = username === currentUsername ? '#4CAF50' : '#f44336';
                ctx.beginPath();
                ctx.arc(player.x, player.y, 25, 0, Math.PI * 2);
                ctx.fill();

                // Draw username and score
                ctx.fillStyle = '#fff';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${username} (${player.score || 0})`, player.x, player.y - 35);
            });
        }

        // Input handling
        const keys = {};
        window.addEventListener('keydown', (e) => {
            keys[e.code] = true;
            if(e.code === 'Space') {
                e.preventDefault();
            }
        });
        window.addEventListener('keyup', (e) => keys[e.code] = false);

        function handleInput() {
            if (!gameState.players[currentUsername]) return;

            const player = gameState.players[currentUsername];
            let moved = false;

            if (keys['ArrowLeft'] && player.x > 25) {
                player.x -= 5;
                moved = true;
            }
            if (keys['ArrowRight'] && player.x < canvas.width - 25) {
                player.x += 5;
                moved = true;
            }
            if (keys['Space'] && player.y >= canvas.height - 100) {
                player.y -= 200;
                moved = true;
            }

            if (moved) {
                socket.emit('player_move', {
                    room_id: roomId,
                    username: currentUsername,
                    position: {
                        x: player.x,
                        y: player.y,
                        score: player.score || 0
                    }
                });
            }
        }

        // Apply gravity
        setInterval(() => {
            if (gameState.players[currentUsername]) {
                const player = gameState.players[currentUsername];
                if (player.y < canvas.height - 100) {
                    player.y = Math.min(player.y + 5, canvas.height - 100);
                    
                    socket.emit('player_move', {
                        room_id: roomId,
                        username: currentUsername,
                        position: {
                            x: player.x,
                            y: player.y,
                            score: player.score || 0
                        }
                    });
                }
            }
        }, 20);

        // Game loop
        function gameLoop() {
            handleInput();
            updateGame();
            requestAnimationFrame(gameLoop);
        }

        // Start the game loop
        gameLoop();

        // Leave room button handler
        document.getElementById('leave-room-btn').addEventListener('click', () => {
            socket.emit('leave_room', {
                room_id: roomId,
                username: currentUsername
            });
            window.location.href = '/lobby';
        });

        // Initial render
        updateGame();
    </script>
</body>
</html> 